name: HansPedder Orchestrator (Evolution & Optimization)

on:
  schedule:
    - cron: '0 * * * *' # K√∏rer hver time
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

env:
  ORCHESTRATOR_NAME: HansPedder
  AGENT_CONFIG: >-
    {
      "FrontendAgent": ["css", "style", "ui", "ux", "design", "html", "frontend", "tailwind", "button", "view", "react", "lucide", "vite"],
      "BackendAgent": ["api", "json", "server", "controller", "java", "c#", "route", "endpoint", "auth", "middleware", "express", "nest"],
      "DataAgent": ["db", "sql", "database", "schema", "query", "postgres", "migration", "table", "column", "redis", "prisma", "typeorm"],
      "DevOpsAgent": ["ci", "cd", "docker", "yaml", "cloud", "deploy", "build", "terraform", "pipeline", "action", "npm", "package"]
    }

jobs:
  orchestrate-evolution:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      checks: read
      statuses: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config user.name "HansPedder Orchestrator"
          git config user.email "hanspedder@widgettdc.dev"

      - name: üß† HansPedder Brain (Repair, Evolve & Optimize)
        id: orchestrate
        env:
          GH_TOKEN: ${{ github.token }}
          CONFIG: ${{ env.AGENT_CONFIG }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        shell: python
        run: |
          import json
          import os
          import re
          import subprocess
          import sys
          import urllib.request
          import time
          import random
          from datetime import datetime

          BRAIN_DIR = ".github/brain"
          MEMORY_FILE = f"{BRAIN_DIR}/evolution.json"

          # --- CORE FUNCTIONS ---
          def run_command(cmd):
              try:
                  result = subprocess.run(cmd, capture_output=True, text=True)
                  if result.returncode != 0:
                      return None, result.stderr.strip()
                  return result.stdout.strip(), None
              except Exception as e:
                  return None, str(e)

          def load_brain():
              if not os.path.exists(BRAIN_DIR): os.makedirs(BRAIN_DIR)
              if os.path.exists(MEMORY_FILE):
                  try:
                      with open(MEMORY_FILE, 'r') as f: return json.load(f)
                  except: return {"patterns": {}, "history": []}
              return {"patterns": {}, "history": []}

          def update_brain(error_key, solution, successful):
              brain = load_brain()
              if error_key not in brain["patterns"]:
                  brain["patterns"][error_key] = {"attempts": 0, "successes": 0, "best_fix": None}
              brain["patterns"][error_key]["attempts"] += 1
              if successful:
                  brain["patterns"][error_key]["successes"] += 1
                  brain["patterns"][error_key]["best_fix"] = solution
              
              with open(MEMORY_FILE, 'w') as f: json.dump(brain, f, indent=2)
              
              run_command(["git", "add", MEMORY_FILE])
              run_command(["git", "commit", "-m", "chore(brain): knowledge updated"])
              run_command(["git", "push", "origin", "main"])

          # --- INTELLIGENCE (DEEPSEEK V3) ---
          def ask_deepseek(context, input_data, mode="fix"):
              api_key = os.environ.get('AI_API_KEY')
              if not api_key: return None

              print(f"üì° Konsulterer DeepSeek ({mode})...")
              
              if mode == "fix":
                  system_prompt = "You are a DevOps Architect. Return ONLY the shell command to fix the error."
              elif mode == "architect":
                  system_prompt = "You are a Chief Architect. Provide a shell command to REFACTOR the problematic file completely."
              elif mode == "optimize":
                  system_prompt = "You are a Code Optimization Expert. Analyze the code. If it can be improved (performance, readability, security), return the FULL REFACTORED CODE ONLY. If it is already good, return 'NO_CHANGE'. Do not include markdown blocks."

              user_prompt = f"Context: {context}. Input: {input_data[:4000]}." # Limit chars
              
              payload = {
                  "model": "deepseek-chat",
                  "messages": [{"role": "system", "content": system_prompt}, {"role": "user", "content": user_prompt}],
                  "temperature": 0.2,
                  "stream": False
              }

              try:
                  req = urllib.request.Request(
                      "https://api.deepseek.com/chat/completions",
                      data=json.dumps(payload).encode('utf-8'),
                      headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}
                  )
                  with urllib.request.urlopen(req) as response:
                      resp_data = json.load(response)
                      content = resp_data['choices'][0]['message']['content'].strip()
                      return content.replace("```bash", "").replace("```javascript", "").replace("```ts", "").replace("```", "").strip()
              except Exception as e:
                  print(f"üí• AI Fejl: {e}")
                  return None

          # --- OPTIMIZATION ROUTINE ---
          def proactive_optimization():
              print("‚ú® Starter proaktiv optimerings-scan...")
              # Find alle kildefiler (js, ts, py, java) men ignorer node_modules og config filer
              files_out, _ = run_command(["git", "ls-files"])
              if not files_out: return

              source_files = [f for f in files_out.split() if f.endswith(('.js', '.ts', '.tsx', '.jsx', '.py', '.java', '.cs')) and 'node_modules' not in f and 'dist' not in f]
              
              if not source_files: return

              # V√¶lg en tilf√¶ldig fil for at optimere l√∏bende over tid
              target_file = random.choice(source_files)
              print(f"üî¨ Analyserer kandidat for optimering: {target_file}")

              with open(target_file, 'r') as f:
                  code_content = f.read()
              
              if len(code_content) < 50 or len(code_content) > 10000:
                  print("Fil for lille eller for stor. Springer over.")
                  return

              optimized_code = ask_deepseek(f"Optimize file: {target_file}", code_content, mode="optimize")

              if optimized_code and optimized_code != "NO_CHANGE" and "class" in optimized_code or "function" in optimized_code or "import" in optimized_code:
                  # Opret PR med optimering
                  branch_name = f"refactor/optimize-{int(time.time())}"
                  run_command(["git", "checkout", "-b", branch_name])
                  
                  with open(target_file, 'w') as f:
                      f.write(optimized_code)
                  
                  run_command(["git", "add", target_file])
                  run_command(["git", "commit", "-m", f"refactor: optimize {target_file} for performance/readability"])
                  run_command(["git", "push", "origin", branch_name])
                  
                  # Opret PR
                  pr_body = f"HansPedder har proaktivt analyseret `{target_file}` og fundet optimeringsmuligheder.\n\nReview venligst √¶ndringerne."
                  run_command(["gh", "pr", "create", "--title", f"‚ö° Refactor: Optimize {target_file}", "--body", pr_body, "--base", "main", "--label", "optimization"])
                  
                  print(f"‚úÖ PR oprettet for optimering af {target_file}")
                  # Skift tilbage til main for resten af scriptet
                  run_command(["git", "checkout", "main"])
              else:
                  print("Kode allerede optimal eller AI afslog √¶ndring.")

          # --- SELF HEALING DEPENDENCIES ---
          def check_dependencies():
              # (Samme kode som f√∏r...)
              files_out, _ = run_command(["git", "grep", "-r", "import", ".", ":!node_modules"])
              if files_out:
                   pkg_out, _ = run_command(["cat", "package.json"])
                   if pkg_out:
                       missing_chk = ask_deepseek("Analyze imports vs package.json. Return npm install command ONLY if missing.", f"Imports: {files_out[:1000]}... Pkg: {pkg_out}", mode="fix")
                       if missing_chk and "npm install" in missing_chk:
                           print(f"üõ°Ô∏è Proaktivt fix: {missing_chk}")
                           run_command(missing_chk.split())
                           return True
              return False

          # --- MAIN LOOP ---
          try:
              print("ü§ñ HansPedder 3.0 (Architect) v√•gner.")
              
              # 1. PRE-CHECK: Dependencies
              if check_dependencies():
                  run_command(["git", "add", "."])
                  run_command(["git", "commit", "-m", "fix(deps): proaktiv heling"])
                  run_command(["git", "push", "origin", "main"])

              # 2. PR MANAGEMENT
              # (Standard logik bevaret, men forkortet her for at passe i svaret)
              output, _ = run_command(["gh", "pr", "list", "--state", "open", "--json", "number,title,body,author"])
              if output:
                  for pr in json.loads(output):
                      if pr['author']['login'] != "github-actions":
                          run_command(["gh", "pr", "merge", str(pr['number']), "--squash", "--auto", "--delete-branch"])

              # 3. SYSTEM HEALTH & EVOLUTION
              output, _ = run_command(["gh", "run", "list", "--branch", "main", "--limit", "1", "--json", "databaseId,status,conclusion,headSha"])
              if output:
                  runs = json.loads(output)
                  if runs and runs[0]['status'] == "completed" and runs[0]['conclusion'] == "failure":
                      # ... (Samme fejlretning som sidst) ...
                      latest = runs[0]
                      print(f"üö® Fejl p√• main (Run {latest['databaseId']}). Starter diagnose.")
                      log_out, _ = run_command(["gh", "run", "view", str(latest['databaseId']), "--log-failed"])
                      solution = ask_deepseek("Fix Build Error", log_out[-2000:] if log_out else "Err", mode="fix")
                      
                      if solution:
                          subprocess.run(solution, shell=True, executable="/bin/bash")
                          run_command(["git", "add", "."])
                          run_command(["git", "commit", "-m", "fix(auto): system healed"])
                          run_command(["git", "push", "origin", "main"])
                      else:
                          # Rollback
                          run_command(["git", "revert", latest['headSha'], "--no-edit"])
                          run_command(["git", "push", "origin", "main"])

              # 4. OPTIMIZATION (NY!)
              # Vi k√∏rer kun optimering, hvis systemet er sundt (dvs. sidste build var succes)
              if runs and runs[0]['conclusion'] == "success":
                  proactive_optimization()

              print("‚úÖ Cyklus f√¶rdig.")

          except Exception as e:
              print(f"üî• FATAL: {e}")
              sys.exit(1)

      - name: üìù TODO Scanner
        uses: alstr/todo-to-issue-action@v4
        continue-on-error: true
        with:
          CLOSE_ISSUES: true
          AUTO_ASSIGN: true
          IDENTIFIERS: '{"TODO": "help wanted", "FIXME": "bug"}'
          IGNORE: '/.github/**'
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: üÜò N√∏d-mail
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üî• HansPedder Critical Failure"
          to: clauskraft@gmail.com
          from: "HansPedder Orchestrator"
          body: "Log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
