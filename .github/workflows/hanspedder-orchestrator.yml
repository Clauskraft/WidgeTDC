name: HansPedder Orchestrator (DeepSeek Autonomous)

on:
  schedule:
    - cron: '0 * * * *' # K√∏rer hver time
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

env:
  ORCHESTRATOR_NAME: HansPedder
  # Konfiguration: Hans Pedders viden om hvem der laver hvad
  AGENT_CONFIG: >-
    {
      "FrontendAgent": ["css", "style", "ui", "ux", "design", "html", "frontend", "tailwind", "button", "view"],
      "BackendAgent": ["api", "json", "server", "controller", "java", "c#", "route", "endpoint", "auth"],
      "DataAgent": ["db", "sql", "database", "schema", "query", "postgres", "migration", "table", "column"],
      "DevOpsAgent": ["ci", "cd", "docker", "yaml", "cloud", "deploy", "build", "terraform", "pipeline", "action"]
    }

jobs:
  orchestrate-system:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      checks: read
      statuses: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # N√∏dvendigt for at kunne lave git revert

      - name: Configure Git identity
        run: |
          git config user.name "HansPedder Orchestrator"
          git config user.email "hanspedder@widgettdc.dev"

      # -------------------------------------------------------
      # STEP 1: DEN STORE HJERNE (Python + DeepSeek)
      # -------------------------------------------------------
      - name: üß† HansPedder Brain (Orchestrate, Protect & Repair)
        id: orchestrate
        env:
          GH_TOKEN: ${{ github.token }}
          CONFIG: ${{ env.AGENT_CONFIG }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }} # DeepSeek n√∏gle
        shell: python
        run: |
          import json
          import os
          import re
          import subprocess
          import sys
          import urllib.request

          # --- HJ√ÜLPEFUNKTION: K√∏r kommando sikkert ---
          def run_command(cmd):
              try:
                  result = subprocess.run(cmd, capture_output=True, text=True)
                  if result.returncode != 0:
                      return None, result.stderr.strip()
                  return result.stdout.strip(), None
              except Exception as e:
                  return None, str(e)

          # --- LIVLINE FUNKTION (DEEPSEEK) ---
          def consult_lifeline(error_msg, context="general"):
              print(f"\nüöë KALDER COPILOT LIVLINE (DEEPSEEK) FOR: {context}")
              
              # NIVEAU 1: Offline Hacks (Gratis og hurtigt)
              fixes = []
              if "index.lock" in error_msg: fixes.append(["rm", "-f", ".git/index.lock"])
              elif "shallow update" in error_msg: fixes.append(["git", "fetch", "--unshallow"])
              elif "refusing to merge unrelated" in error_msg: fixes.append(["git", "merge", "--allow-unrelated-histories"])
              elif "conflict" in error_msg.lower() and "automatic merge failed" in error_msg.lower(): fixes.append(["git", "merge", "--abort"])
              
              if fixes:
                  for fix_cmd in fixes:
                      print(f"üîß Fors√∏ger offline fix: {' '.join(fix_cmd)}")
                      out, err = run_command(fix_cmd)
                      if not err: return True
                  return False

              # NIVEAU 2: Online AI (DeepSeek V3)
              api_key = os.environ.get('AI_API_KEY')
              if not api_key:
                  print("‚ö†Ô∏è Ingen AI_API_KEY fundet. Kan ikke sp√∏rge DeepSeek.")
                  return False

              print("üì° Kontakter DeepSeek API for en l√∏sning...")
              
              system_prompt = "You are a Git Expert Agent. Return ONLY the single shell command needed to fix the user's error. Do not use markdown blocks. Do not explain. Just the command."
              user_prompt = f"Context: {context}. Error: {error_msg}. Repo path is current directory."
              
              payload = {
                  "model": "deepseek-chat",
                  "messages": [
                      {"role": "system", "content": system_prompt},
                      {"role": "user", "content": user_prompt}
                  ],
                  "temperature": 0.1,
                  "stream": False
              }

              try:
                  req = urllib.request.Request(
                      "https://api.deepseek.com/chat/completions",
                      data=json.dumps(payload).encode('utf-8'),
                      headers={
                          "Authorization": f"Bearer {api_key}",
                          "Content-Type": "application/json"
                      }
                  )
                  
                  with urllib.request.urlopen(req) as response:
                      resp_data = json.load(response)
                      ai_command = resp_data['choices'][0]['message']['content'].strip()
                      
                      # Rens markdown (DeepSeek kan v√¶re snakkesalig)
                      ai_command = ai_command.replace("```bash", "").replace("```sh", "").replace("```", "").strip()

                      if "rm -rf /" in ai_command or "sudo" in ai_command:
                          print(f"‚õî DeepSeek foreslog farlig kommando: {ai_command}")
                          return False

                      print(f"ü§ñ DeepSeek Foresl√•r: {ai_command}")
                      
                      cmd_list = ai_command.split()
                      out, err = run_command(cmd_list)
                      
                      if not err:
                          print("‚úÖ AI Fix udf√∏rt succesfuldt!")
                          return True
                      else:
                          print(f"‚ùå AI Fix fejlede: {err}")
                          return False

              except Exception as e:
                  print(f"üí• Fejl ved kald til DeepSeek: {str(e)}")
                  return False

          # --- HOVEDPROGRAM ---
          try:
              print("ü§ñ HansPedder v√•gner. Status: Autonom.")
              agent_keywords = json.loads(os.environ['CONFIG'])
              orchestrator_name = "HansPedder"
              
              # === 1. PR MANAGEMENT ===
              print("\n--- 1. Analyserer Pull Requests ---")
              output, err = run_command(["gh", "pr", "list", "--state", "open", "--json", "number,title,body,author,headRefName"])
              
              if err:
                  if consult_lifeline(err, "PR List"):
                      output, err = run_command(["gh", "pr", "list", "--state", "open", "--json", "number,title,body,author"])

              if output:
                  prs = json.loads(output)
                  for pr in prs:
                      try:
                          if pr['author']['login'] == "github-actions": continue 
                          number = pr['number']
                          title = pr['title']
                          body = pr['body'] if pr['body'] else ""
                          original_body = body
                          
                          print(f"Behandler PR #{number}: {title}")

                          # A. Allokering
                          agent_match = re.search(r'Agent:\s*([A-Za-z0-9_]+)', body)
                          current_agent = agent_match.group(1) if agent_match else None
                          
                          if not current_agent:
                              full_text = (title + " " + body).lower()
                              best_agent = orchestrator_name
                              max_matches = 0
                              for name, keys in agent_keywords.items():
                                  matches = sum(1 for k in keys if k in full_text)
                                  if matches > max_matches:
                                      max_matches = matches
                                      best_agent = name
                              current_agent = best_agent
                              body += f"\nAgent: {current_agent}"

                          # B. Metadata Defaults
                          if "Block:" not in body: body += "\nBlock: 99"
                          if "Points:" not in body: body += "\nPoints: 1"

                          # C. Opdater Body
                          if body != original_body:
                              run_command(["gh", "pr", "edit", str(number), "--body", body])

                          # D. Semantisk Titel Fix
                          clean_title = re.sub(r'[^a-zA-Z0-9 ]', '', title.replace("READY FOR MERGE", "")).strip()
                          if not re.match(r'^(feat|fix|docs|chore|style|refactor|test):', clean_title):
                              prefix = "fix" if "fix" in clean_title.lower() else "feat"
                              new_title = f"{prefix}: [{current_agent}] - {clean_title}"[:200]
                              run_command(["gh", "pr", "edit", str(number), "--title", new_title])

                          # E. Auto-Merge
                          out, merge_err = run_command(["gh", "pr", "merge", str(number), "--squash", "--auto", "--delete-branch"])
                          if merge_err and "conflict" in merge_err:
                              consult_lifeline(merge_err, f"Merge PR #{number}")

                      except Exception as pr_e:
                          print(f"‚ö†Ô∏è Fejl i PR #{number}. Forts√¶tter til n√¶ste.")
                          continue

              # === 2. DRIFT & ROLLBACK ===
              print("\n--- 2. System Health Check ---")
              output, err = run_command(["gh", "run", "list", "--branch", "main", "--limit", "1", "--json", "status,conclusion,headSha,url"])
              
              if output:
                  runs = json.loads(output)
                  if runs:
                      latest = runs[0]
                      if latest['status'] == "completed" and latest['conclusion'] == "failure":
                          print("üö® KRITISK FEJL P√Ö MAIN! Starter Rollback.")
                          
                          # Tjek om vi allerede har rullet tilbage
                          issues_out, _ = run_command(["gh", "issue", "list", "--search", "Auto-Rollback", "--json", "title"])
                          if f"Reverted {latest['headSha'][:7]}" in str(issues_out):
                              print("Allerede h√•ndteret.")
                          else:
                              # K√∏r Git operationer
                              run_command(["git", "fetch", "origin", "main"])
                              run_command(["git", "checkout", "main"])
                              run_command(["git", "pull", "origin", "main"])
                              
                              revert_out, revert_err = run_command(["git", "revert", latest['headSha'], "--no-edit"])
                              
                              if revert_err:
                                  print("‚ùå Revert fejlede. Kalder DeepSeek!")
                                  if consult_lifeline(revert_err, "Emergency Rollback"):
                                      # Pr√∏v igen hvis DeepSeek fiksede det
                                      revert_out, revert_err = run_command(["git", "revert", latest['headSha'], "--no-edit"])
                                      if revert_err: raise Exception(f"Kunne ikke rulle tilbage: {revert_err}")
                                  else:
                                      raise Exception(f"DeepSeek kunne ikke l√∏se rollback fejlen.")
                              
                              # Push
                              push_out, push_err = run_command(["git", "push", "origin", "main"])
                              if push_err:
                                  if not consult_lifeline(push_err, "Git Push"):
                                      raise Exception("Kunne ikke pushe rollback.")
                                  run_command(["git", "push", "origin", "main"])

                              print("‚úÖ Rollback udf√∏rt.")
                              msg = f"Build fejlede ({latest['url']}). Jeg har rullet commit {latest['headSha']} tilbage."
                              run_command(["gh", "issue", "create", "--title", f"üõ°Ô∏è Auto-Rollback: Reverted {latest['headSha'][:7]}", "--body", msg, "--label", "urgent"])

              print("‚úÖ HansPedder cyklus f√¶rdig.")

          except Exception as fatal_error:
              print(f"üî• FATAL FEJL: {str(fatal_error)}")
              sys.exit(1)

      # -------------------------------------------------------
      # STEP 2: TODO SCANNER (KORREKT CONFIG)
      # -------------------------------------------------------
      - name: üìù Konverter TODOs til Issues
        uses: alstr/todo-to-issue-action@v4
        id: todo
        continue-on-error: true
        with:
          CLOSE_ISSUES: true
          AUTO_ASSIGN: true
          IDENTIFIERS: '{"TODO": "help wanted", "FIXME": "bug"}'
          # VIGTIGT: Ignorerer workflow filer s√• den ikke scanner sig selv
          IGNORE: '/.github/workflows/*.yml, *.json'
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # -------------------------------------------------------
      # STEP 3: N√òDBREMSE (MAIL)
      # -------------------------------------------------------
      - name: üÜò Send N√∏d-mail til Claus
        if: failure() # K√∏rer KUN hvis DeepSeek og Python scriptet giver op
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üî• HansPedder Alarm: Selv DeepSeek kunne ikke hj√¶lpe"
          to: clauskraft@gmail.com
          from: "HansPedder Orchestrator"
          body: |
            Hej Claus,

            Dette er en n√∏dmeddelelse. 
            Jeg st√∏dte p√• en fejl, og selvom jeg spurgte DeepSeek om hj√¶lp, kunne vi ikke l√∏se det automatisk.

            Manuel indgriben er p√•kr√¶vet.
            
            Log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Vh, HansPedder ü§ñ
