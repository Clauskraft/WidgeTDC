name: HansPedder Orchestrator (Ultimate Autonomy)

on:
  # K√∏rer hver time for at tjekke systemets helbred og rydde op
  schedule:
    - cron: '0 * * * *'
  # K√∏rer ogs√• n√•r agenterne √•bner eller opdaterer PRs
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

env:
  ORCHESTRATOR_NAME: HansPedder
  # HansPedders viden om hvem der laver hvad (udvid efter behov)
  AGENT_CONFIG: >-
    {
      "FrontendAgent": ["css", "style", "ui", "ux", "design", "html", "frontend", "tailwind", "button", "view"],
      "BackendAgent": ["api", "json", "server", "controller", "java", "c#", "route", "endpoint", "auth"],
      "DataAgent": ["db", "sql", "database", "schema", "query", "postgres", "migration", "table", "column"],
      "DevOpsAgent": ["ci", "cd", "docker", "yaml", "cloud", "deploy", "build", "terraform", "pipeline", "action"]
    }

jobs:
  orchestrate-system:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      checks: read
      statuses: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # N√∏dvendigt for at kunne lave git revert

      - name: Configure Git identity
        run: |
          git config user.name "HansPedder Orchestrator"
          git config user.email "hanspedder@widgettdc.dev"

      - name: üß† HansPedder Brain (Orchestrate & Protect)
        id: orchestrate
        env:
          GH_TOKEN: ${{ github.token }}
          CONFIG: ${{ env.AGENT_CONFIG }}
        shell: python
        run: |
          import json
          import os
          import re
          import subprocess
          import sys

          # Helper til at k√∏re shell kommandoer
          def run_command(cmd):
              result = subprocess.run(cmd, capture_output=True, text=True)
              if result.returncode != 0:
                  # Vi kaster kun fejl ved kritiske git operationer, ikke ved 'not found' checks
                  if "git" in cmd[0]:
                      raise Exception(f"Command failed: {result.stderr}")
              return result.stdout.strip()

          try:
              print("ü§ñ HansPedder v√•gner op. Starter driftsrutine...")
              
              agent_keywords = json.loads(os.environ['CONFIG'])
              orchestrator_name = "HansPedder"
              actions_log = []
              
              # =========================================================
              # FASE 1: PR ORKESTRERING (Manager Rollen)
              # =========================================================
              print("\n--- 1. Analyserer Pull Requests ---")
              prs_json = run_command(["gh", "pr", "list", "--state", "open", "--json", "number,title,body,author,headRefName"])
              prs = json.loads(prs_json)
              
              for pr in prs:
                  # Ignorer egne PRs for at undg√• loops
                  if pr['author']['login'] == "github-actions": continue 
                  
                  number = pr['number']
                  title = pr['title']
                  body = pr['body'] if pr['body'] else ""
                  original_body = body
                  
                  print(f"Behandler PR #{number}: {title}")

                  # A. Data Udtr√¶k
                  agent_match = re.search(r'Agent:\s*([A-Za-z0-9_]+)', body)
                  block_match = re.search(r'Block:\s*(\d+)', body)
                  
                  current_agent = agent_match.group(1) if agent_match else None
                  current_block = block_match.group(1) if block_match else "99" # Default: Maintenance
                  
                  # B. Smart Allokering (hvis agent mangler)
                  if not current_agent:
                      full_text = (title + " " + body).lower()
                      best_agent = orchestrator_name
                      max_matches = 0
                      
                      for name, keys in agent_keywords.items():
                          matches = sum(1 for k in keys if k in full_text)
                          if matches > max_matches:
                              max_matches = matches
                              best_agent = name
                      
                      current_agent = best_agent
                      body += f"\nAgent: {current_agent}"
                      actions_log.append(f"PR #{number}: Allokeret til {current_agent}")

                  # C. Standardisering af metadata
                  if not block_match: body += f"\nBlock: {current_block}"
                  if "Points:" not in body: body += "\nPoints: 1"

                  # Opdater PR body hvis √¶ndret
                  if body != original_body:
                      run_command(["gh", "pr", "edit", str(number), "--body", body])
                  
                  # D. Semantisk Titel Fix
                  # Fjerner emojis og 'READY FOR MERGE' tekst for at lave ren titel
                  clean_title = re.sub(r'[^a-zA-Z0-9 ]', '', title.replace("READY FOR MERGE", "")).strip()
                  
                  # Tjekker om den allerede er compliant (feat:, fix:, etc.)
                  if not re.match(r'^(feat|fix|docs|chore|style|refactor|perf|test|build|ci|revert):', clean_title):
                      # G√¶tter type: fix hvis 'fix' indg√•r, ellers feat
                      prefix = "fix" if "fix" in clean_title.lower() else "feat"
                      new_title = f"{prefix}: [{current_agent}] Block {current_block} - {clean_title}"
                      
                      # Klipper titel hvis for lang
                      if len(new_title) > 200: new_title = new_title[:197] + "..."
                      
                      run_command(["gh", "pr", "edit", str(number), "--title", new_title])
                      print(f"  > Omd√∏bt til: {new_title}")

                  # E. Auto-Merge Fors√∏g
                  # --auto flaget fort√¶ller GitHub at merge N√ÖR checks passerer
                  try:
                      run_command(["gh", "pr", "merge", str(number), "--squash", "--auto", "--delete-branch"])
                      print(f"  > Auto-merge aktiveret for PR #{number}")
                  except Exception:
                      pass # Kan fejle hvis der er konflikter, men det er OK (vi pr√∏ver igen n√¶ste time)

              # =========================================================
              # FASE 2: CIRCUIT BREAKER (Driftschef Rollen)
              # =========================================================
              print("\n--- 2. System Health Check (Main Branch) ---")
              
              # Hent status p√• seneste k√∏rsel p√• main
              runs_json = run_command(["gh", "run", "list", "--branch", "main", "--limit", "1", "--json", "status,conclusion,url,headSha"])
              runs = json.loads(runs_json)
              
              if runs:
                  latest_run = runs[0]
                  status = latest_run['status']
                  conclusion = latest_run['conclusion']
                  
                  print(f"Status p√• main: {status} - {conclusion}")
                  
                  # Hvis buildet er f√¶rdigt og fejlet -> ALARM
                  if status == "completed" and conclusion == "failure":
                      print("üö® KRITISK: Build p√• main er fejlet! Starter N√òD-PROCEDURE.")
                      
                      bad_commit = latest_run['headSha']
                      
                      # Tjek om vi allerede har reageret (for at undg√• uendeligt loop af rollbacks)
                      issues_json = run_command(["gh", "issue", "list", "--state", "open", "--search", "Auto-Rollback", "--json", "title"])
                      
                      if f"Reverted {bad_commit[:7]}" not in str(issues_json):
                          try:
                              # 1. Synkroniser local git
                              run_command(["git", "fetch", "origin", "main"])
                              run_command(["git", "checkout", "main"])
                              run_command(["git", "pull", "origin", "main"])
                              
                              # 2. Udf√∏r Revert
                              print(f"Reverting commit {bad_commit}...")
                              run_command(["git", "revert", bad_commit, "--no-edit"])
                              
                              # 3. Push √¶ndringen (dette trigger et nyt, forh√•bentlig gr√∏nt build)
                              run_command(["git", "push", "origin", "main"])
                              print("‚úÖ Rollback udf√∏rt succesfuldt.")
                              
                              # 4. Opret Issue til DevOpsAgent
                              issue_title = f"üõ°Ô∏è Auto-Rollback: Reverted {bad_commit[:7]}"
                              issue_body = f"""
                              ### üõ°Ô∏è System Protection Triggered
                              HansPedder her. Buildet p√• `main` fejlede, s√• jeg har rullet √¶ndringen tilbage for at sikre driften.
                              
                              - **Bad Commit:** {bad_commit}
                              - **Failed Run:** {latest_run['url']}
                              
                              **Opgave:**
                              @DevOpsAgent - Analyser venligst hvorfor buildet fejlede lokalt, f√∏r du fors√∏ger at merge igen.
                              """
                              run_command(["gh", "issue", "create", "--title", issue_title, "--body", issue_body, "--label", "bug,urgent"])
                              
                          except Exception as e:
                              print(f"‚ùå Rollback fejlede: {str(e)}")
                              raise e # Dette vil trigger mail-steppet nedenfor
                      else:
                          print("Rollback allerede udf√∏rt for denne commit. Afventer manuelt fix.")
                  
                  elif conclusion == "success":
                      print("‚úÖ Systemet er sundt. Ingen handling p√•kr√¶vet.")

              # Gem statistik til output
              with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
                  print("status=success", file=fh)

          except Exception as e:
              print(f"FATAL ERROR I HANSPEDDER: {str(e)}")
              # Skriv fejlen til log fil s√• mailen kan l√¶se den (hvis vi vil udvide det)
              sys.exit(1)

      # =========================================================
      # FASE 3: FAILSAFE (Human-in-the-loop)
      # =========================================================
      - name: üÜò Send N√∏d-mail til Claus
        if: failure() # K√∏rer KUN hvis Python scriptet crasher
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üî• HansPedder System Crash / Rollback Fejl"
          to: clauskraft@gmail.com
          from: "HansPedder Orchestrator"
          body: |
            Hej Claus,

            Dette er en n√∏dmeddelelse. Din orkestrator agent (HansPedder) er st√∏dt p√• en kritisk fejl, som han ikke selv kunne l√∏se.
            
            Det kan skyldes:
            1. En fejl i selve orkestrerings-scriptet.
            2. Et fors√∏g p√• automatisk rollback, der fejlede.

            Se loggen her for detaljer:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Vh,
            HansPedder ü§ñ
