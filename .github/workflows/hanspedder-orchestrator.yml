name: HansPedder Orchestrator (Unstoppable)

on:
  schedule:
    - cron: '0 * * * *' # K√∏rer hver time
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

env:
  ORCHESTRATOR_NAME: HansPedder
  AGENT_CONFIG: >-
    {
      "FrontendAgent": ["css", "style", "ui", "ux", "design", "html", "frontend", "tailwind", "button", "view"],
      "BackendAgent": ["api", "json", "server", "controller", "java", "c#", "route", "endpoint", "auth"],
      "DataAgent": ["db", "sql", "database", "schema", "query", "postgres", "migration", "table", "column"],
      "DevOpsAgent": ["ci", "cd", "docker", "yaml", "cloud", "deploy", "build", "terraform", "pipeline", "action"]
    }

jobs:
  orchestrate-system:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      checks: read
      statuses: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Vigtig for rollback logik

      - name: Configure Git identity
        run: |
          git config user.name "HansPedder Orchestrator"
          git config user.email "hanspedder@widgettdc.dev"

      # -------------------------------------------------------
      # STEP 1: DEN STORE HJERNE (Python Logic)
      # -------------------------------------------------------
      - name: üß† HansPedder Brain (Orchestrate & Protect)
        id: orchestrate
        env:
          GH_TOKEN: ${{ github.token }}
          CONFIG: ${{ env.AGENT_CONFIG }}
        shell: python
        run: |
          import json
          import os
          import re
          import subprocess
          import sys

          def run_command(cmd):
              # Vi k√∏rer kommandoer sikkert
              result = subprocess.run(cmd, capture_output=True, text=True)
              if result.returncode != 0:
                  # Returner fejlbesked i stedet for at crashe scriptet med det samme
                  return None, result.stderr
              return result.stdout.strip(), None

          try:
              print("ü§ñ HansPedder v√•gner. Sikrer kontinuerlig drift...")
              
              agent_keywords = json.loads(os.environ['CONFIG'])
              orchestrator_name = "HansPedder"
              
              # --- FASE A: PR MANAGEMENT (LOOPS M√Ö IKKE STOPPE) ---
              print("\n--- 1. Analyserer Pull Requests ---")
              output, err = run_command(["gh", "pr", "list", "--state", "open", "--json", "number,title,body,author,headRefName"])
              
              if output:
                  prs = json.loads(output)
                  for pr in prs:
                      # Vi pakker hver PR ind i try/except s√• √©n fejl ikke stopper de andre
                      try:
                          if pr['author']['login'] == "github-actions": continue 
                          
                          number = pr['number']
                          title = pr['title']
                          body = pr['body'] if pr['body'] else ""
                          original_body = body
                          
                          print(f"Behandler PR #{number}: {title}")

                          # 1. Find eller Alloker Agent
                          agent_match = re.search(r'Agent:\s*([A-Za-z0-9_]+)', body)
                          current_agent = agent_match.group(1) if agent_match else None
                          
                          if not current_agent:
                              full_text = (title + " " + body).lower()
                              best_agent = orchestrator_name
                              max_matches = 0
                              for name, keys in agent_keywords.items():
                                  matches = sum(1 for k in keys if k in full_text)
                                  if matches > max_matches:
                                      max_matches = matches
                                      best_agent = name
                              current_agent = best_agent
                              body += f"\nAgent: {current_agent}"

                          # 2. S√¶t Defaults
                          if "Block:" not in body: body += "\nBlock: 99"
                          if "Points:" not in body: body += "\nPoints: 1"

                          # 3. Opdater Body (hvis √¶ndret)
                          if body != original_body:
                              run_command(["gh", "pr", "edit", str(number), "--body", body])

                          # 4. Fix Titel (Semantic)
                          clean_title = re.sub(r'[^a-zA-Z0-9 ]', '', title.replace("READY FOR MERGE", "")).strip()
                          if not re.match(r'^(feat|fix|docs|chore|style|refactor|test):', clean_title):
                              prefix = "fix" if "fix" in clean_title.lower() else "feat"
                              new_title = f"{prefix}: [{current_agent}] - {clean_title}"[:200]
                              run_command(["gh", "pr", "edit", str(number), "--title", new_title])

                          # 5. Enable Auto-Merge
                          run_command(["gh", "pr", "merge", str(number), "--squash", "--auto", "--delete-branch"])

                      except Exception as pr_error:
                          print(f"‚ö†Ô∏è Fejl ved PR #{number}: {str(pr_error)} - Springer over og forts√¶tter.")
                          continue # VIGTIGT: Vi forts√¶tter til n√¶ste PR

              # --- FASE B: CIRCUIT BREAKER (DRIFT) ---
              print("\n--- 2. System Health Check (Main Branch) ---")
              output, err = run_command(["gh", "run", "list", "--branch", "main", "--limit", "1", "--json", "status,conclusion,url,headSha"])
              
              if output:
                  runs = json.loads(output)
                  if runs:
                      latest = runs[0]
                      # Hvis main er crashet (completed + failure)
                      if latest['status'] == "completed" and latest['conclusion'] == "failure":
                          print("üö® KRITISK: Main branch er nede! Starter rollback.")
                          
                          bad_commit = latest['headSha']
                          
                          # Tjek om vi allerede har en sag p√• det
                          issues_out, _ = run_command(["gh", "issue", "list", "--search", "Auto-Rollback", "--json", "title"])
                          
                          if f"Reverted {bad_commit[:7]}" not in str(issues_out):
                              # Udf√∏r Revert
                              subprocess.run(["git", "fetch", "origin", "main"], check=False)
                              subprocess.run(["git", "checkout", "main"], check=False)
                              subprocess.run(["git", "pull", "origin", "main"], check=False)
                              
                              revert_res = subprocess.run(["git", "revert", bad_commit, "--no-edit"], capture_output=True)
                              
                              if revert_res.returncode == 0:
                                  subprocess.run(["git", "push", "origin", "main"], check=False)
                                  
                                  # Opret Issue
                                  msg = f"Jeg har rullet commit {bad_commit} tilbage for at redde produktionen."
                                  run_command(["gh", "issue", "create", "--title", f"üõ°Ô∏è Auto-Rollback: Reverted {bad_commit[:7]}", "--body", msg, "--label", "urgent"])
                                  print("‚úÖ Rollback udf√∏rt.")
                              else:
                                  print(f"‚ùå Kunne ikke udf√∏re rollback automatisk: {revert_res.stderr}")
                                  # Her crasher vi med vilje for at sende mail, da manuel hj√¶lp er p√•kr√¶vet
                                  sys.exit(1)
                          else:
                              print("Rollback allerede h√•ndteret.")

              print("‚úÖ HansPedder cyklus gennemf√∏rt.")

          except Exception as global_e:
              print(f"FATAL FEJL: {str(global_e)}")
              sys.exit(1)

      # -------------------------------------------------------
      # -------------------------------------------------------
      # STEP 2: AVANCERET TODO SCANNER (MED FIX FOR SELV-SCANNING)
      # -------------------------------------------------------
      - name: üìù Konverter TODOs til Rigtige Issues
        uses: alstr/todo-to-issue-action@v4
        id: todo
        continue-on-error: true
        with:
          CLOSE_ISSUES: true
          AUTO_ASSIGN: true
          IDENTIFIERS: '{"TODO": "help wanted", "FIXME": "bug"}'
          
          # HER ER FIXET: Vi beder den ignorere workflow-filer og json filer
          IGNORE: '/.github/workflows/*.yml, *.json'
          
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # -------------------------------------------------------
      # STEP 3: N√òDBREMSE (MAIL)
      # -------------------------------------------------------
      - name: üÜò Send N√∏d-mail til Claus
        if: failure() # K√∏rer KUN hvis Python scriptet crasher fatal (sys.exit 1)
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üî• HansPedder Alarm: Manuel hj√¶lp p√•kr√¶vet"
          to: clauskraft@gmail.com
          from: "HansPedder Orchestrator"
          body: |
            Hej Claus,

            HansPedder her. Jeg har fors√∏gt at holde driften k√∏rende, men st√∏dte p√• en fejl jeg ikke kunne h√•ndtere autonomt.
            
            Mulig √•rsag:
            - Automatisk rollback fejlede (merge conflict under revert).
            - GitHub API svarer ikke.

            Log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Vh, HansPedder ü§ñ
