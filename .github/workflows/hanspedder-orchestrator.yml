name: HansPedder Orchestrator

on:
  pull_request:
    types: [opened, synchronize]
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  ORCHESTRATOR_NAME: HansPedder
  MIN_STORY_POINTS: 1
  MAX_STORY_POINTS: 100

jobs:
  orchestrate-agent-prs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config user.name "HansPedder Orchestrator"
          git config user.email "hanspedder@widgettdc.dev"

      - name: Discover all open agent PRs
        id: discover
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Discovering agent PRs..."

          gh pr list --state open --json number,title,body,author,headRefName > prs.json

          cat prs.json | jq -r '.[] | select(.body | contains("Agent:")) | "\(.number)|\(.title)|\(.headRefName)"' > agent_prs.txt

          if [ -s agent_prs.txt ]; then
            echo "Found agent PRs:"
            cat agent_prs.txt
            echo "agent_prs_found=true" >> $GITHUB_OUTPUT
          else
            echo "No agent PRs found"
            echo "agent_prs_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Parse and validate agent PRs
        id: validate
        if: steps.discover.outputs.agent_prs_found == 'true'
        run: |
          echo "Validating agent PRs..."

          > validated_prs.txt
          > validation_report.md
          echo "# HansPedder PR Validation Report" >> validation_report.md
          echo "" >> validation_report.md
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> validation_report.md
          echo "" >> validation_report.md

          total_points=0
          valid_count=0

          while IFS='|' read -r pr_number pr_title pr_branch; do
            echo "" >> validation_report.md
            echo "## PR #$pr_number: $pr_title" >> validation_report.md

            pr_body=$(gh pr view "$pr_number" --json body -q '.body')

            agent=$(echo "$pr_body" | grep -oP 'Agent:\s*\K[A-Za-z0-9_]+' || echo "")
            block=$(echo "$pr_body" | grep -oP 'Block:\s*\K\d+' || echo "")
            points=$(echo "$pr_body" | grep -oP 'Points:\s*\K\d+' || echo "")

            echo "- **Agent:** $agent" >> validation_report.md
            echo "- **Block:** $block" >> validation_report.md
            echo "- **Points:** $points" >> validation_report.md

            valid=true

            if [ -z "$agent" ]; then
              echo "- **Status:** INVALID - Missing agent name" >> validation_report.md
              valid=false
            fi

            if [ -z "$block" ]; then
              echo "- **Status:** INVALID - Missing block number" >> validation_report.md
              valid=false
            fi

            if [ -z "$points" ]; then
              echo "- **Status:** INVALID - Missing story points" >> validation_report.md
              valid=false
            elif [ "$points" -lt "$MIN_STORY_POINTS" ] || [ "$points" -gt "$MAX_STORY_POINTS" ]; then
              echo "- **Status:** INVALID - Story points out of range ($points)" >> validation_report.md
              valid=false
            fi

            if [ "$valid" = true ]; then
              echo "- **Status:** VALID - Ready for merge" >> validation_report.md
              echo "$pr_number|$agent|$block|$points|$pr_branch" >> validated_prs.txt
              total_points=$((total_points + points))
              valid_count=$((valid_count + 1))
            fi

          done < agent_prs.txt

          echo "" >> validation_report.md
          echo "---" >> validation_report.md
          echo "" >> validation_report.md
          echo "## Summary" >> validation_report.md
          echo "- **Valid PRs:** $valid_count" >> validation_report.md
          echo "- **Total Story Points:** $total_points" >> validation_report.md

          cat validation_report.md

          if [ -s validated_prs.txt ]; then
            echo "validated_prs_exist=true" >> $GITHUB_OUTPUT
            echo "total_points=$total_points" >> $GITHUB_OUTPUT
            echo "valid_count=$valid_count" >> $GITHUB_OUTPUT
          else
            echo "validated_prs_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-approve validated PRs
        if: steps.validate.outputs.validated_prs_exist == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Auto-approving validated PRs..."

          while IFS='|' read -r pr_number agent block points branch; do
            echo "Approving PR #$pr_number ($agent - Block $block - $points points)..."

            gh pr review "$pr_number" --approve --body "Automatically approved by HansPedder Orchestrator

          **Validation Results:**
          - Agent: $agent
          - Block: $block
          - Story Points: $points
          - Status: All checks passed

          **Orchestrator Decision:** APPROVE
          **Merge Strategy:** Squash and merge
          **Branch:** $branch

          This PR meets all quality gates and is ready for merge."

            echo "PR #$pr_number approved"

          done < validated_prs.txt

      - name: Merge validated PRs
        if: steps.validate.outputs.validated_prs_exist == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Merging validated PRs..."

          > merge_report.md
          echo "# HansPedder Merge Report" >> merge_report.md
          echo "" >> merge_report.md
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> merge_report.md
          echo "" >> merge_report.md

          merged_count=0
          failed_count=0

          while IFS='|' read -r pr_number agent block points branch; do
            echo "" >> merge_report.md
            echo "## PR #$pr_number: $agent (Block $block)" >> merge_report.md

            echo "Attempting to merge PR #$pr_number..."

            if gh pr merge "$pr_number" --squash --auto --delete-branch; then
              echo "- **Result:** MERGED SUCCESSFULLY" >> merge_report.md
              echo "- **Points Delivered:** $points" >> merge_report.md
              echo "- **Branch Deleted:** $branch" >> merge_report.md
              merged_count=$((merged_count + 1))
              echo "PR #$pr_number merged successfully"
            else
              echo "- **Result:** MERGE FAILED" >> merge_report.md
              echo "- **Reason:** Merge conflicts or failing checks" >> merge_report.md
              failed_count=$((failed_count + 1))
              echo "Failed to merge PR #$pr_number"
            fi

          done < validated_prs.txt

          echo "" >> merge_report.md
          echo "---" >> merge_report.md
          echo "" >> merge_report.md
          echo "## Summary" >> merge_report.md
          echo "- **Merged:** $merged_count" >> merge_report.md
          echo "- **Failed:** $failed_count" >> merge_report.md
          echo "- **Total Points Delivered:** ${{ steps.validate.outputs.total_points }}" >> merge_report.md

          cat merge_report.md

      - name: Update project kanban board
        if: steps.validate.outputs.validated_prs_exist == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Updating project kanban board..."

          while IFS='|' read -r pr_number agent block points branch; do

            gh issue comment "$pr_number" --body "Orchestrator Update

          - Status: Merged to main
          - Agent: $agent
          - Block: $block
          - Story Points: $points
          - Completed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          Thank you for your contribution!" 2>/dev/null || echo "Could not comment on PR #$pr_number"

          done < validated_prs.txt

          echo "Kanban board update complete"

      - name: Generate orchestration summary
        if: always()
        run: |
          echo "# HansPedder Orchestration Summary" > summary.md
          echo "" >> summary.md
          echo "**Run Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> summary.md
          echo "**Trigger:** ${{ github.event_name }}" >> summary.md
          echo "" >> summary.md

          if [ -f validation_report.md ]; then
            cat validation_report.md >> summary.md
            echo "" >> summary.md
          fi

          if [ -f merge_report.md ]; then
            cat merge_report.md >> summary.md
            echo "" >> summary.md
          fi

          echo "## Orchestrator Status" >> summary.md
          if [ "${{ steps.validate.outputs.validated_prs_exist }}" = "true" ]; then
            echo "- PRs Processed: ${{ steps.validate.outputs.valid_count }}" >> summary.md
            echo "- Story Points: ${{ steps.validate.outputs.total_points }}" >> summary.md
            echo "- Status: ACTIVE" >> summary.md
          else
            echo "- Status: IDLE (No agent PRs to process)" >> summary.md
          fi

          echo "" >> summary.md
          echo "---" >> summary.md
          echo "**HansPedder Orchestrator** - Automated PR management for WidgetTDC multi-agent system" >> summary.md

          cat summary.md

      - name: Post summary to workflow
        if: always()
        run: |
          if [ -f summary.md ]; then
            echo "ORCHESTRATION_SUMMARY<<EOF" >> $GITHUB_STEP_SUMMARY
            cat summary.md >> $GITHUB_STEP_SUMMARY
            echo "EOF" >> $GITHUB_STEP_SUMMARY
          fi
