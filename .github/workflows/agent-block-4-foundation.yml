name: Agent Block 4 - DatabaseMaster

on:
  workflow_run:
    workflows: ["Agent Block 3 - APISpecialist"]
    types:
      - completed
  workflow_dispatch:

env:
  AGENT_NAME: DatabaseMaster
  BLOCK_NUMBER: 4
  STORY_POINTS: 50

jobs:
  database-foundation:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config user.name "DatabaseMaster Agent"
          git config user.email "databasemaster@widgettdc.dev"

      - name: Create feature branch
        run: |
          BRANCH_NAME="agent/block-4-database-foundation"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create database directory structure
        run: |
          mkdir -p database/models
          mkdir -p database/migrations
          mkdir -p database/seeds
          echo "Database directories created"

      - name: Create User model
        run: |
          cat > database/models/User.js << 'EOF'
          const { DataTypes } = require('sequelize');

          module.exports = (sequelize) => {
            const User = sequelize.define('User', {
              id: {
                type: DataTypes.UUID,
                defaultValue: DataTypes.UUIDV4,
                primaryKey: true
              },
              username: {
                type: DataTypes.STRING(50),
                allowNull: false,
                unique: true
              },
              email: {
                type: DataTypes.STRING(100),
                allowNull: false,
                unique: true,
                validate: { isEmail: true }
              },
              passwordHash: {
                type: DataTypes.STRING(255),
                allowNull: false
              },
              isActive: {
                type: DataTypes.BOOLEAN,
                defaultValue: true
              },
              isVerified: {
                type: DataTypes.BOOLEAN,
                defaultValue: false
              },
              role: {
                type: DataTypes.ENUM('admin', 'developer', 'user'),
                defaultValue: 'user'
              }
            }, {
              tableName: 'users',
              timestamps: true
            });

            return User;
          };
          EOF

      - name: Create Widget model
        run: |
          cat > database/models/Widget.js << 'EOF'
          const { DataTypes } = require('sequelize');

          module.exports = (sequelize) => {
            const Widget = sequelize.define('Widget', {
              id: {
                type: DataTypes.UUID,
                defaultValue: DataTypes.UUIDV4,
                primaryKey: true
              },
              name: {
                type: DataTypes.STRING(100),
                allowNull: false
              },
              description: {
                type: DataTypes.TEXT
              },
              version: {
          git commit -m "feat: Implement foundation systems with database layer - DatabaseMaster Block 4 (50pts)"
              ownerId: {
                type: DataTypes.UUID,
                allowNull: false,
                references: {
                  model: 'users',
                  key: 'id'
                }
              }
            }, {
              tableName: 'widgets',
              timestamps: true
            });

            return Widget;
          };
          EOF

      - name: Create initial migration
        run: |
          cat > database/migrations/001-create-users-table.sql << 'EOF'
          -- Migration: Create users table
          CREATE TABLE IF NOT EXISTS users (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            username VARCHAR(50) UNIQUE NOT NULL,
            email VARCHAR(100) UNIQUE NOT NULL,
            password_hash VARCHAR(255) NOT NULL,
            is_active BOOLEAN DEFAULT true,
            is_verified BOOLEAN DEFAULT false,
            role VARCHAR(20) DEFAULT 'user',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          CREATE INDEX idx_users_username ON users(username);
          CREATE INDEX idx_users_email ON users(email);
          CREATE INDEX idx_users_role ON users(role);
          EOF

      - name: Create widgets migration
        run: |
          cat > database/migrations/002-create-widgets-table.sql << 'EOF'
          -- Migration: Create widgets table
          CREATE TABLE IF NOT EXISTS widgets (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            name VARCHAR(100) NOT NULL,
            description TEXT,
            version VARCHAR(20) NOT NULL,
            price DECIMAL(10, 2) NOT NULL,
            stock_quantity INTEGER DEFAULT 0,
            owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          CREATE INDEX idx_widgets_name ON widgets(name);
          CREATE INDEX idx_widgets_owner ON widgets(owner_id);
          CREATE INDEX idx_widgets_version ON widgets(version);
          EOF

      - name: Create database config
        run: |
          cat > database/config.js << 'EOF'
          module.exports = {
            development: {
              username: process.env.DB_USER || 'postgres',
              password: process.env.DB_PASSWORD || 'password',
              database: process.env.DB_NAME || 'widgettdc_dev',
              host: process.env.DB_HOST || 'localhost',
              port: process.env.DB_PORT || 5432,
              dialect: 'postgres'
            },
            test: {
              username: process.env.DB_USER || 'postgres',
              password: process.env.DB_PASSWORD || 'password',
              database: 'widgettdc_test',
              host: 'localhost',
              port: 5432,
              dialect: 'postgres'
            },
            production: {
              username: process.env.DB_USER,
              password: process.env.DB_PASSWORD,
              database: process.env.DB_NAME,
              host: process.env.DB_HOST,
              port: process.env.DB_PORT || 5432,
              dialect: 'postgres',
              ssl: true
            }
          };
          EOF

      - name: Create seed data
        run: |
          cat > database/seeds/001-demo-users.js << 'EOF'
          module.exports = {
            up: async (queryInterface) => {
              await queryInterface.bulkInsert('users', [
                {
                  id: '550e8400-e29b-41d4-a716-446655440000',
                  username: 'admin',
                  email: 'admin@widgettdc.dev',
                  password_hash: 'hashed_password_here',
                  role: 'admin',
                  is_verified: true,
                  created_at: new Date(),
                  updated_at: new Date()
                },
                {
                  id: '550e8400-e29b-41d4-a716-446655440001',
                  username: 'developer',
                  email: 'dev@widgettdc.dev',
                  password_hash: 'hashed_password_here',
                  role: 'developer',
                  is_verified: true,
                  created_at: new Date(),
                  updated_at: new Date()
                }
              ]);
            },
            down: async (queryInterface) => {
              await queryInterface.bulkDelete('users', null, {});
            }
          };
          EOF

      - name: Commit database foundation
        run: |
          git add .
          git commit -m "Agent: DatabaseMaster | Block: 4 | Points: 50

          Implement database foundation with models and migrations

          - Created User model with authentication fields
          - Created Widget model with owner relationship
          - Generated initial database migrations
          - Added database configuration for all environments
          - Created demo seed data
          - Established indexes for query optimization

          Dependencies: Block 3 (APISpecialist)"

      - name: Push feature branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Block 4: DatabaseMaster - Database Models and Migrations (50 points)" \
            --body "## DatabaseMaster Agent - Block 4

          **Story Points:** 50
          **Agent:** DatabaseMaster
          **Block Number:** 4

          ### Implementation Summary
          Database foundation with Sequelize models and SQL migrations

          ### Changes Made
          - User model with authentication and roles
          - Widget model with owner relationships
          - Initial SQL migrations for PostgreSQL
          - Database configuration for all environments
          - Demo seed data for development

          ### Dependencies
          - Depends on: Block 3 (APISpecialist)
          - Blocks: Block 5 (QASpecialist)

          Agent: DatabaseMaster | Block: 4 | Points: 50" \
            --base main \
            --head $BRANCH_NAME
