# WidgetTDC Error Recovery Strategies
# Declarative error handling configuration for agent cascade execution
# Inspired by Kestra workflow orchestration patterns
# Defines recovery actions for different error types

# Error categories and recovery strategies
strategies:

  # ========== AUTHENTICATION ERRORS ==========
  github_auth_failure:
    category: AUTHENTICATION
    severity: CRITICAL
    action: retry
    max_attempts: 3
    backoff:
      type: exponential
      initial_delay: 2
      max_delay: 30
      multiplier: 2
    recovery_action: refresh_github_token
    on_failure: escalate_to_admin
    description: "GitHub token expired or invalid"

  github_permission_denied:
    category: AUTHENTICATION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: notify_permission_required
    required_resolution: manual
    description: "GitHub App lacks required permissions"

  git_config_missing:
    category: AUTHENTICATION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: configure_git_identity
    required_resolution: manual
    description: "Git user.name or user.email not configured"

  # ========== RESOURCE ERRORS ==========
  disk_space_insufficient:
    category: RESOURCE
    severity: CRITICAL
    action: next
    cleanup_required: true
    cleanup_actions:
      - clear_cache
      - remove_temp_files
      - clear_docker_images
    after_cleanup: retry
    max_attempts: 2
    description: "Insufficient disk space for execution"

  memory_insufficient:
    category: RESOURCE
    severity: CRITICAL
    action: next
    cleanup_required: true
    cleanup_actions:
      - stop_background_services
      - clear_memory_cache
    after_cleanup: continue_with_reduced_resources
    description: "Insufficient memory for agent execution"

  timeout_exceeded:
    category: RESOURCE
    severity: RECOVERABLE
    action: retry
    max_attempts: 2
    backoff:
      type: exponential
      initial_delay: 5
      max_delay: 60
      multiplier: 2
    timeout_adjustment: increase_by_50_percent
    description: "Agent execution timed out"

  # ========== VALIDATION ERRORS ==========
  yaml_syntax_invalid:
    category: VALIDATION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: suggest_yaml_fix
    on_failure: show_yaml_diff
    description: "YAML file has syntax errors"

  schema_validation_failed:
    category: VALIDATION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: validate_against_schema
    on_failure: suggest_schema_fix
    description: "Agent definition doesn't match schema"

  dependency_missing:
    category: VALIDATION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: install_missing_dependency
    required_resolution: manual
    description: "Required dependency not available (npm package, tool, etc.)"

  # ========== NETWORK ERRORS ==========
  network_timeout:
    category: NETWORK
    severity: RECOVERABLE
    action: retry
    max_attempts: 3
    backoff:
      type: exponential
      initial_delay: 1
      max_delay: 30
      multiplier: 2
    description: "Network request timed out"

  connection_refused:
    category: NETWORK
    severity: RECOVERABLE
    action: retry
    max_attempts: 3
    backoff:
      type: exponential
      initial_delay: 2
      max_delay: 30
      multiplier: 2
    recovery_action: wait_for_service_ready
    description: "Connection refused - service may be starting"

  github_api_rate_limit:
    category: NETWORK
    severity: RECOVERABLE
    action: retry
    backoff:
      type: linear
      initial_delay: 60
      max_delay: 3600
      multiplier: 1
    wait_strategy: exponential_jitter
    description: "GitHub API rate limit exceeded - wait and retry"

  dns_resolution_failed:
    category: NETWORK
    severity: RECOVERABLE
    action: retry
    max_attempts: 3
    backoff:
      type: exponential
      initial_delay: 2
      max_delay: 30
      multiplier: 2
    recovery_action: retry_with_alternate_dns
    description: "DNS resolution failed"

  # ========== EXECUTION ERRORS ==========
  command_not_found:
    category: EXECUTION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: suggest_tool_install
    description: "Required command/tool not found in PATH"

  permission_denied_on_file:
    category: EXECUTION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: suggest_chmod_fix
    required_resolution: manual
    description: "Permission denied when accessing file"

  process_exit_non_zero:
    category: EXECUTION
    severity: RECOVERABLE
    action: retry
    max_attempts: 2
    backoff:
      type: exponential
      initial_delay: 1
      max_delay: 10
      multiplier: 2
    on_repeated_failure: escalate_with_logs
    description: "Process exited with non-zero status"

  script_assertion_failed:
    category: EXECUTION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: show_assertion_details
    on_failure: suggest_fix_based_on_assertion
    description: "Assertion or validation check failed"

  # ========== GITHUB WORKFLOW ERRORS ==========
  workflow_syntax_error:
    category: WORKFLOW
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: validate_workflow_syntax
    on_failure: suggest_workflow_fix
    description: "GitHub workflow YAML syntax error"

  branch_protection_violation:
    category: WORKFLOW
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: check_branch_rules
    required_resolution: manual
    description: "PR blocked by branch protection rules"

  pr_merge_conflict:
    category: WORKFLOW
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: suggest_conflict_resolution
    required_resolution: manual
    description: "Pull request has merge conflicts"

  # ========== APPLICATION ERRORS ==========
  registry_validation_failed:
    category: APPLICATION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: validate_registry_schema
    on_failure: show_registry_errors
    description: "Agent registry doesn't match schema"

  state_file_corrupted:
    category: APPLICATION
    severity: CRITICAL
    action: fail
    max_attempts: 0
    recovery_action: restore_from_backup
    required_resolution: manual
    description: "Cascade state file is corrupted"

  state_write_failed:
    category: APPLICATION
    severity: RECOVERABLE
    action: retry
    max_attempts: 3
    backoff:
      type: exponential
      initial_delay: 1
      max_delay: 10
      multiplier: 2
    recovery_action: check_disk_permissions
    description: "Failed to write cascade state"

  # ========== UNKNOWN/UNEXPECTED ERRORS ==========
  unknown_error:
    category: UNKNOWN
    severity: CRITICAL
    action: next
    cleanup_required: false
    after_cleanup: fail
    recovery_action: collect_diagnostics
    on_failure: report_to_admin
    description: "Unexpected error - requires manual investigation"

# ========== GLOBAL RECOVERY SETTINGS ==========
global:
  # Maximum retries across all retry-able errors
  max_total_retries: 10

  # Timeout for cascade execution (hours)
  cascade_timeout: 3

  # Timeout per agent block (minutes)
  block_timeout: 60

  # Enable auto-escalation to admin on repeated failures
  auto_escalate: true
  escalation_threshold: 3

  # Enable automatic diagnostics collection on failure
  collect_diagnostics: true
  diagnostics_output: ".claude/diagnostics/"

  # Enable state rollback on failure
  state_rollback_on_failure: true

  # Notify on errors
  notifications:
    enabled: true
    channels:
      - stdout
      - state_file
    on_critical: immediate
    on_recoverable: after_max_retries

# ========== RECOVERY ACTIONS REFERENCE ==========
# These actions are performed by exception-handler.sh and bug-finder.sh

recovery_actions:
  refresh_github_token:
    description: "Refresh GitHub authentication token"
    command: "gh auth refresh"

  clear_cache:
    description: "Clear temporary cache directories"
    command: "rm -rf .cache/* /tmp/*"

  remove_temp_files:
    description: "Remove temporary files from execution"
    command: "find . -name '*.tmp' -o -name '*.bak' | xargs rm -f"

  install_missing_dependency:
    description: "Install missing npm/system dependency"
    command: "npm install || apt-get install"

  wait_for_service_ready:
    description: "Wait for service to be ready"
    command: "sleep 5 && curl -s http://localhost:8080/health"

  collect_diagnostics:
    description: "Collect system and execution diagnostics"
    command: "bash scripts/collect-diagnostics.sh"

  report_to_admin:
    description: "Send error report to admin"
    command: "bash scripts/send-alert.sh"

  show_assertion_details:
    description: "Display assertion failure details"
    command: "jq '.errors[-1]' .claude/agent-state.json"

# ========== ERROR PATTERNS FOR BUG FINDER ==========
# Used by bug-finder.sh for intelligent error diagnosis

error_patterns:
  github_auth:
    patterns:
      - ".*authentication.*failed.*"
      - ".*401.*unauthorized.*"
      - ".*token.*invalid.*"
      - ".*permission.*denied.*"
    recovery_suggestions:
      - "Check GITHUB_TOKEN environment variable"
      - "Run: gh auth login"
      - "Verify token has required scopes"

  disk_space:
    patterns:
      - ".*no space left.*"
      - ".*disk.*full.*"
      - ".*ENOSPC.*"
      - ".*out of disk space.*"
    recovery_suggestions:
      - "Free up disk space (need â‰¥1GB)"
      - "Clear cache: rm -rf .cache/*"
      - "Remove Docker images: docker system prune"

  network:
    patterns:
      - ".*connection.*refused.*"
      - ".*timeout.*"
      - ".*network.*unreachable.*"
      - ".*DNS.*resolution.*"
    recovery_suggestions:
      - "Check network connectivity"
      - "Verify firewall rules"
      - "Try with different DNS"
      - "Wait for service to be ready"

  yaml_syntax:
    patterns:
      - ".*YAML.*error.*"
      - ".*yaml.*parse.*"
      - ".*invalid.*YAML.*"
    recovery_suggestions:
      - "Run: yamllint agents/registry.yml"
      - "Check indentation (spaces, not tabs)"
      - "Validate against schema"

  permission:
    patterns:
      - ".*permission.*denied.*"
      - ".*access.*denied.*"
      - ".*EACCES.*"
    recovery_suggestions:
      - "Check file permissions: chmod +x script.sh"
      - "Check directory ownership"
      - "Verify GitHub App permissions"
