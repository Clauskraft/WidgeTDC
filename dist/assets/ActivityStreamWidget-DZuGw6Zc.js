import{r as l,j as e}from"./ui-d27jHJxv.js";import{B as x}from"./Button-CUGYQXiP.js";import{f as F,g as I,a as w}from"./securityApi-Bh3J2vfj.js";import"./vendor-BerfLJhL.js";const N=[{id:"evt-1101",title:"Critical credential dump ingested",description:"Dark web feed normalized 1.2k new credentials tied to finance leadership.",category:"alert",severity:"critical",source:"Feed Ingestion",rule:"critical-credential-dump",timestamp:"2025-11-18T08:18:00Z",acknowledged:!1,channel:"SSE"},{id:"evt-1098",title:"Vendor advisory indexed",description:"Vendor Radar pushed CVE-2025-1123 advisory with compensating controls.",category:"ingestion",severity:"high",source:"Vendor Radar",rule:"vendor-critical",timestamp:"2025-11-18T08:12:00Z",acknowledged:!1,channel:"Job"},{id:"evt-1095",title:"Automation run completed",description:"Playbook reset credentials for exposed accounts (14 targets).",category:"automation",severity:"medium",source:"Automation Engine",rule:"auto-reset",timestamp:"2025-11-18T08:07:00Z",acknowledged:!0,channel:"Webhook"},{id:"evt-1092",title:"SOC analyst acknowledged incident",description:"Incident #432 reassigned to Tier-2 and acknowledged.",category:"audit",severity:"low",source:"SOC Console",rule:"incident-ack",timestamp:"2025-11-18T07:58:00Z",acknowledged:!0,channel:"Webhook"}],L={low:"bg-emerald-100 text-emerald-700 border-emerald-200",medium:"bg-amber-100 text-amber-700 border-amber-200",high:"bg-orange-100 text-orange-700 border-orange-200",critical:"bg-rose-100 text-rose-700 border-rose-200"},D={ingestion:"bg-blue-50 text-blue-700 border-blue-200",alert:"bg-rose-50 text-rose-700 border-rose-200",automation:"bg-emerald-50 text-emerald-700 border-emerald-200",audit:"bg-slate-50 text-slate-700 border-slate-200"},J=()=>{var j;const[r,n]=l.useState(N),[h,b]=l.useState("all"),[u,f]=l.useState("all"),[c,k]=l.useState(!0),[S,p]=l.useState(!1),[v,o]=l.useState(null),m=l.useRef(null),y=l.useRef([]);l.useEffect(()=>{let t=!1;return(async()=>{var a;try{const s=await F({limit:25});!t&&((a=s==null?void 0:s.events)!=null&&a.length)&&n(s.events)}catch(s){console.warn("Security activity fetch failed",s),t||o("Activity service offline; showing cached events.")}})(),()=>{t=!0}},[]),l.useEffect(()=>{if(!c){m.current&&(m.current.close(),m.current=null),p(!1);return}if(typeof window>"u"||typeof window.EventSource>"u"){o("Realtime stream unavailable in this environment.");return}const t=new window.EventSource(I());return m.current=t,t.onopen=()=>{p(!0),o(null)},t.onerror=()=>{p(!1),o("Realtime stream disconnected.")},t.addEventListener("security-bootstrap",a=>{try{const s=JSON.parse(a.data);n(s)}catch(s){console.warn("Failed to parse bootstrap payload",s)}}),t.addEventListener("security-activity",a=>{try{const s=JSON.parse(a.data);n(i=>[s,...i].slice(0,50))}catch(s){console.warn("Failed to parse activity payload",s)}}),t.addEventListener("security-heartbeat",()=>{p(!0)}),()=>{t.close(),m.current=null}},[c]),l.useEffect(()=>{if(!c)return;const t=setInterval(()=>{n(a=>{const s=y.current.shift();if(!s)return a;const i={...s,timestamp:new Date().toISOString()};return y.current.push({...s,id:`${s.id}-${Date.now()}`,timestamp:new Date().toISOString()}),[i,...a].slice(0,12)})},12e3);return()=>clearInterval(t)},[c]);const d=l.useMemo(()=>r.filter(t=>{const a=h==="all"?!0:t.severity===h,s=u==="all"?!0:t.category===u;return a&&s}),[r,h,u]),A=r.filter(t=>!t.acknowledged&&(t.severity==="high"||t.severity==="critical")).length,E=((j=r[0])==null?void 0:j.timestamp)??N[0].timestamp,C=l.useCallback(async(t,a)=>{n(s=>s.map(i=>i.id===t?{...i,acknowledged:a}:i));try{await w(t,a)}catch(s){console.warn("Failed to update acknowledgement",s),n(i=>i.map(g=>g.id===t?{...g,acknowledged:!a}:g)),o("Unable to persist acknowledgement.")}},[]),R=l.useCallback(async()=>{const t=d.filter(a=>!a.acknowledged).map(a=>a.id);t.length!==0&&(n(a=>a.map(s=>t.includes(s.id)?{...s,acknowledged:!0}:s)),await Promise.all(t.map(a=>w(a,!0).catch(()=>{}))))},[d]);return e.jsxs("div",{className:"h-full flex flex-col -m-4","data-testid":"activity-stream-widget",children:[e.jsx("header",{className:"p-4 bg-slate-950/85 text-white border-b border-slate-800",children:e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-white/60",children:"Cyberstreams Track 2.B"}),e.jsx("h3",{className:"text-2xl font-semibold",children:"Activity Stream · Real-time Security Feed"}),e.jsx("p",{className:"text-sm text-white/80",children:"Server-sent events pipeline consolidating alerts, automation runs and audit actions."})]}),e.jsxs("div",{className:"text-right min-w-[180px]",children:[e.jsx("p",{className:"text-xs text-white/70",children:"Last delivery"}),e.jsx("p",{className:"text-lg font-semibold",children:new Date(E).toLocaleTimeString()}),e.jsxs("p",{className:"text-xs text-white/60",children:["Streaming ",c?"ON":"PAUSED"," · ",S?"connected":"offline"]})]})]})}),e.jsxs("div",{className:"flex-1 grid grid-cols-12 gap-4 p-4 bg-slate-50 dark:bg-slate-900/30 overflow-hidden",children:[e.jsxs("section",{className:"col-span-12 xl:col-span-4 flex flex-col gap-4",children:[e.jsxs("div",{className:"border border-slate-200 dark:border-slate-800 rounded-2xl bg-white dark:bg-slate-900/70 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Filters"}),e.jsx(x,{variant:"subtle",size:"small",onClick:()=>{b("all"),f("all")},children:"Reset"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-600 dark:text-slate-300 mb-1 block",htmlFor:"severity-filter",children:"Severity"}),e.jsxs("select",{id:"severity-filter",value:h,onChange:t=>b(t.target.value),className:"w-full rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm bg-white/80 dark:bg-slate-950/40",children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"critical",children:"Critical"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-600 dark:text-slate-300 mb-1 block",htmlFor:"category-filter",children:"Category"}),e.jsxs("select",{id:"category-filter",value:u,onChange:t=>f(t.target.value),className:"w-full rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm bg-white/80 dark:bg-slate-950/40",children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"alert",children:"Alert"}),e.jsx("option",{value:"ingestion",children:"Ingestion"}),e.jsx("option",{value:"automation",children:"Automation"}),e.jsx("option",{value:"audit",children:"Audit"})]})]})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-3",children:[e.jsx(x,{variant:c?"success":"subtle",size:"small",onClick:()=>k(t=>!t),children:c?"Pause stream":"Resume stream"}),e.jsx(x,{variant:"primary",size:"small",onClick:R,children:"Acknowledge all"})]}),v&&e.jsx("p",{className:"text-xs text-amber-600 mt-2",children:v})]}),e.jsxs("div",{className:"border border-slate-200 dark:border-slate-800 rounded-2xl bg-white dark:bg-slate-900/70 p-4",children:[e.jsx("h4",{className:"font-semibold text-sm mb-3",children:"SLA & metrics"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Active alerts"}),e.jsx("p",{className:"text-2xl font-semibold",children:A})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"SSE uptime"}),e.jsx("p",{className:"text-2xl font-semibold",children:"99.99%"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Average delivery"}),e.jsx("p",{className:"text-2xl font-semibold",children:"86 ms"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Buffer depth"}),e.jsxs("p",{className:"text-2xl font-semibold",children:[Math.max(0,r.length-d.length)," events"]})]})]}),e.jsxs("p",{className:"text-xs text-slate-500 mt-3",children:["Source channels: SSE (",r.filter(t=>t.channel==="SSE").length,"), Webhook (",r.filter(t=>t.channel==="Webhook").length,"), Job (",r.filter(t=>t.channel==="Job").length,")"]})]})]}),e.jsxs("section",{className:"col-span-12 xl:col-span-8 border border-slate-200 dark:border-slate-800 rounded-2xl bg-white dark:bg-slate-900/70 p-4 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Live events"}),e.jsxs("p",{className:"text-xs text-slate-500",children:[d.length," displayed / ",r.length," total"]})]}),e.jsxs("div",{className:"space-y-3 overflow-auto","data-testid":"activity-events",children:[d.map(t=>e.jsxs("article",{className:"p-3 border border-slate-100 dark:border-slate-800 rounded-xl","data-testid":"activity-event",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:t.title}),e.jsxs("p",{className:"text-xs text-slate-500",children:[new Date(t.timestamp).toLocaleString()," · ",t.source]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:`px-2 py-0.5 rounded-full border ${L[t.severity]}`,children:t.severity.toUpperCase()}),e.jsx("span",{className:`px-2 py-0.5 rounded-full border ${D[t.category]}`,children:t.category}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800",children:t.channel})]})]}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-300 mt-2",children:t.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs mt-2",children:[e.jsxs("span",{children:["Rule: ",t.rule]}),e.jsxs("span",{children:["Status: ",t.acknowledged?"Acknowledged":"Open"]})]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx(x,{variant:"primary",size:"small",children:"Drill-down"}),e.jsx(x,{variant:t.acknowledged?"subtle":"success",size:"small",onClick:()=>C(t.id,!t.acknowledged),children:t.acknowledged?"Re-open":"Acknowledge"})]})]},t.id)),d.length===0&&e.jsx("div",{className:"text-sm text-slate-500 border border-dashed border-slate-200 rounded-xl p-6 text-center",children:"No events match the selected filters."})]})]})]})]})};export{J as default};
