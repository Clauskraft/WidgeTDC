import{r as n,j as g}from"./ui-d27jHJxv.js";import{G as M,M as K}from"./index-CHxrVzz6.js";import{B as P}from"./Button-CUGYQXiP.js";import"./vendor-BerfLJhL.js";var N={};function L(o){const c=atob(o),x=c.length,e=new Uint8Array(x);for(let l=0;l<x;l++)e[l]=c.charCodeAt(l);return e}function _(o){let c="";const x=o.byteLength;for(let e=0;e<x;e++)c+=String.fromCharCode(o[e]);return btoa(c)}async function U(o,c,x,e){const l=new Int16Array(o.buffer),h=l.length/e,y=c.createBuffer(e,h,x);for(let m=0;m<e;m++){const S=y.getChannelData(m);for(let i=0;i<h;i++)S[i]=l[i*e+m]/32768}return y}const z=()=>{const[o,c]=n.useState(!1),[x,e]=n.useState("Klar til at starte"),[l,h]=n.useState([]),y=n.useRef(null),m=n.useRef(null),S=n.useRef(null),i=n.useRef(null),C=n.useRef(null),k=n.useRef(null),R=n.useRef(0),b=n.useRef(new Set);n.useEffect(()=>{var r;(r=y.current)==null||r.scrollIntoView({behavior:"smooth"})},[l]);const A=n.useCallback(()=>{var r,v,t,d;e("Stopper..."),c(!1),(r=m.current)==null||r.then(f=>f.close()),m.current=null,(v=S.current)==null||v.getTracks().forEach(f=>f.stop()),S.current=null,(t=k.current)==null||t.disconnect(),k.current=null,(d=i.current)==null||d.close(),i.current=null,b.current.forEach(f=>f.stop()),b.current.clear(),e("Klar til at starte")},[]);n.useEffect(()=>()=>{o&&A()},[o,A]);const B=async()=>{if(!N.API_KEY){e("API nøgle mangler. Sæt den i secrets.");return}e("Starter..."),h([]),c(!0);try{const r=await navigator.mediaDevices.getUserMedia({audio:!0});S.current=r,i.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3}),C.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}),R.current=0;const v=new M({apiKey:N.API_KEY});m.current=v.live.connect({model:"gemini-2.5-flash-native-audio-preview-09-2025",config:{responseModalities:[K.AUDIO],inputAudioTranscription:{},outputAudioTranscription:{}},callbacks:{onopen:()=>{e("Lytter...");const t=i.current.createMediaStreamSource(r);k.current=i.current.createScriptProcessor(4096,1,1),k.current.onaudioprocess=d=>{var T;const f=d.inputBuffer.getChannelData(0),j={data:_(new Uint8Array(new Int16Array(f.map(w=>w*32768)).buffer)),mimeType:"audio/pcm;rate=16000"};(T=m.current)==null||T.then(w=>w.sendRealtimeInput({media:j}))},t.connect(k.current),k.current.connect(i.current.destination)},onmessage:async t=>{var f,j,T,w,E,I,D;if((f=t.serverContent)!=null&&f.inputTranscription){const{text:p}=t.serverContent.inputTranscription,s=!!t.serverContent.turnComplete;h(u=>{const a=u[u.length-1];return(a==null?void 0:a.speaker)==="user"&&!a.isFinal?[...u.slice(0,-1),{speaker:"user",text:p,isFinal:s}]:[...u,{speaker:"user",text:p,isFinal:s}]})}if((j=t.serverContent)!=null&&j.outputTranscription){const{text:p}=t.serverContent.outputTranscription,s=!!t.serverContent.turnComplete;h(u=>{const a=u[u.length-1];return(a==null?void 0:a.speaker)==="model"&&!a.isFinal?[...u.slice(0,-1),{speaker:"model",text:p,isFinal:s}]:[...u,{speaker:"model",text:p,isFinal:s}]})}const d=(I=(E=(w=(T=t.serverContent)==null?void 0:T.modelTurn)==null?void 0:w.parts[0])==null?void 0:E.inlineData)==null?void 0:I.data;if(d&&C.current){e("Taler...");const p=await U(L(d),C.current,24e3,1),s=C.current.createBufferSource();s.buffer=p,s.connect(C.current.destination);const u=C.current.currentTime,a=Math.max(u,R.current);s.start(a),R.current=a+p.duration,b.current.add(s),s.onended=()=>{b.current.delete(s),b.current.size===0&&e("Lytter...")}}(D=t.serverContent)!=null&&D.interrupted&&(b.current.forEach(p=>p.stop()),b.current.clear(),R.current=0)},onclose:()=>{e("Forbindelse lukket."),A()},onerror:t=>{const d=t.message||"En ukendt WebSocket-fejl opstod.";console.error("Live Conversation WebSocket error:",d,t),e(`Fejl i forbindelse: ${d}`),A()}}})}catch(r){console.error("Could not start conversation:",r),e("Kunne ikke få adgang til mikrofon."),c(!1)}},F=()=>{o?A():B()};return g.jsxs("div",{className:"h-full flex flex-col -m-4",children:[g.jsxs("div",{className:"flex-1 p-4 overflow-y-auto space-y-3",children:[l.map((r,v)=>g.jsx("div",{className:`flex ${r.speaker==="user"?"justify-end":"justify-start"}`,children:g.jsx("p",{className:`p-2 rounded-lg max-w-[85%] text-sm ${r.speaker==="user"?"bg-blue-100 dark:bg-blue-900/70":"bg-gray-100 dark:bg-gray-700"} ${r.isFinal?"":"opacity-70"}`,children:r.text})},v)),g.jsx("div",{ref:y})]}),g.jsxs("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 flex flex-col items-center gap-2",children:[g.jsx(P,{onClick:F,variant:o?"destructive":"success",className:"px-6 rounded-full",children:o?"Stop Samtale":"Start Samtale"}),g.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:x})]})]})};export{z as default};
